<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FitPaw Assistant Demo</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#111b27; --border:rgba(255,255,255,.12); --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65); --accent:#7c3aed; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:900px; margin:0 auto; padding:18px 14px 110px; }
    .title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title h1{ margin:0; font-size:28px; }
    .title p{ margin:6px 0 0; color:var(--muted); }
    .card{ margin-top:14px; background:linear-gradient(180deg, rgba(17,27,39,.92), rgba(15,22,32,.92)); border:1px solid var(--border); border-radius:18px; padding:12px; }
    .chat{ height:60vh; overflow:auto; padding:6px; }

    .msg{
      max-width:78%;
      padding:12px 12px;
      border-radius:16px;
      margin:10px 6px;
      line-height:1.35;
      border:1px solid var(--border);
      white-space: normal; /* allow formatting */
    }
    .me{ margin-left:auto; background:rgba(124,58,237,.15); border-color:rgba(124,58,237,.30); }
    .bot{ margin-right:auto; background:rgba(255,255,255,.06); }

    .bar{ position:fixed; left:0; right:0; bottom:0; padding:12px 14px; background:rgba(17,27,39,.72); border-top:1px solid var(--border); backdrop-filter: blur(10px); }
    .composer{ max-width:900px; margin:0 auto; display:flex; gap:10px; align-items:center; }
    input{ flex:1; padding:14px 14px; border-radius:16px; border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--text); outline:none; }
    input::placeholder{ color:rgba(255,255,255,.45); }
    button{ width:48px; height:48px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; }
    button:hover{ border-color:rgba(124,58,237,.55); box-shadow:0 0 0 4px rgba(124,58,237,.12); }
    button:disabled{ cursor:not-allowed; opacity:.6; }

    .row{ display:flex; gap:10px; align-items:center; }
    .small{ color:var(--muted); font-size:13px; }
    code{ color: rgba(124,58,237,.95); }

    /* loader bubble */
    .typing{ display:flex; gap:8px; align-items:center; }
    .gear{
      display:inline-block;
      width:18px; height:18px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.45);
      border-top-color:rgba(124,58,237,.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .dots span{
      display:inline-block; width:6px; height:6px;
      border-radius:999px;
      background:rgba(255,255,255,.45);
      margin-right:4px;
      animation: bounce 1.1s infinite ease-in-out;
    }
    .dots span:nth-child(2){ animation-delay: .15s; }
    .dots span:nth-child(3){ animation-delay: .30s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity:.55; }
      40% { transform: translateY(-4px); opacity:1; }
    }

    /* nice text spacing (for formatted assistant messages) */
    .msg p{ margin: 0 0 10px; }
    .msg p:last-child{ margin-bottom:0; }
    .msg ul{ margin: 0 0 10px 18px; padding:0; }
    .msg li{ margin: 4px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>FitPaw Assistant (Demo)</h1>
        <p class="small">Test chat UI â†’ hits <code>/api/assistant/chat/</code></p>
      </div>
      <div class="row">
        <button id="clearBtn" title="Clear">â†º</button>
      </div>
    </div>

    <div class="card">
      <div id="chat" class="chat"></div>
    </div>
  </div>

  <div class="bar">
    <div class="composer">
      <input id="input" placeholder="Ask about schedule, trainers, QR, workouts..." autocomplete="off"/>
      <button id="sendBtn" title="Send">âž¤</button>
    </div>
  </div>

<script>
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");

  // bump version so old history doesn't break formatting
  const STORAGE_KEY = "fitpaw_assistant_demo_history_v2";

  function escapeHtml(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Markdown-lite: paragraphs + "- " bullet lists
  function renderTextToHtml(text){
    const safe = escapeHtml(text || "");
    const lines = safe.split("\n");

    let html = "";
    let inList = false;

    function closeList(){
      if(inList){ html += "</ul>"; inList = false; }
    }

    for(const raw of lines){
      const line = raw.trim();

      if(!line){
        closeList();
        continue;
      }

      if(line.startsWith("- ")){
        if(!inList){ html += "<ul>"; inList = true; }
        html += "<li>" + line.slice(2) + "</li>";
        continue;
      }

      closeList();
      html += "<p>" + line + "</p>";
    }

    closeList();
    return html || "<p></p>";
  }

  function addMsg(role, text, opts = {}){
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "me" : "bot");

    if(opts.loading){
      div.dataset.loading = "1";
      div.innerHTML = `
        <div class="typing">
          <span class="gear"></span>
          <span class="dots"><span></span><span></span><span></span></span>
          <span class="small" style="margin-left:6px;">Thinking...</span>
        </div>
      `;
    }else{
      if(role === "user"){
        div.textContent = text;              // user stays plain
      }else{
        div.innerHTML = renderTextToHtml(text); // assistant is formatted
      }
    }

    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const hist = JSON.parse(raw);
      hist.forEach(m => addMsg(m.role, m.text));
    }catch(e){}
  }

  function saveHistory(role, text){
    const raw = localStorage.getItem(STORAGE_KEY);
    const hist = raw ? JSON.parse(raw) : [];
    hist.push({role, text});
    localStorage.setItem(STORAGE_KEY, JSON.stringify(hist));
  }

  function setUiBusy(isBusy){
    sendBtn.disabled = isBusy;
    inputEl.disabled = isBusy;
  }

  async function send(){
    const message = (inputEl.value || "").trim();
    if(!message) return;

    inputEl.value = "";
    addMsg("user", message);
    saveHistory("user", message);

    setUiBusy(true);
    const loadingEl = addMsg("assistant", "", {loading: true});

    try{
      const res = await fetch("/api/assistant/chat/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message})
      });

      const data = await res.json();
      const reply = (data && data.reply) ? data.reply : (data && data.message ? JSON.stringify(data) : "No reply");

      // Replace loader with real assistant message
      loadingEl.dataset.loading = "";
      loadingEl.innerHTML = renderTextToHtml(reply);

      saveHistory("assistant", reply);
    }catch(err){
      loadingEl.dataset.loading = "";
      loadingEl.innerHTML = renderTextToHtml("Error: " + err.message);
      saveHistory("assistant", "Error: " + err.message);
    }finally{
      setUiBusy(false);
      chatEl.scrollTop = chatEl.scrollHeight;
      inputEl.focus();
    }
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter") send();
  });

  clearBtn.addEventListener("click", () => {
    localStorage.removeItem(STORAGE_KEY);
    chatEl.innerHTML = "";
    addMsg("assistant", "Hi! Ask me about schedule, trainers, QR, or general gym tips ðŸ™‚");
  });

  loadHistory();
  if(chatEl.children.length === 0){
    addMsg("assistant", "Hi! Ask me about schedule, trainers, QR, or general gym tips ðŸ™‚");
  }
</script>
</body>
</html>
